///----------------------------------------------------------------------------------------------------
/// Copyright (c) Raidcore.GG - All rights reserved.
///
/// Name         :  Addon.h
/// Description  :  Addon implementation.
/// Authors      :  K. Bieniek
///----------------------------------------------------------------------------------------------------

#ifndef ADDON_H
#define ADDON_H

#include <condition_variable>
#include <cstdint>
#include <filesystem>
#include <mutex>
#include <queue>
#include <thread>

#include "AddConst.h"
#include "AddEnum.h"
#include "Core/Addons/Config/CfgManager.h"
#include "Core/Addons/Config/Config.h"
#include "Core/Addons/Definitions/AddonDefV1.h"
#include "Engine/Events/EvtApi.h"
#include "Engine/Loader/LdrAddonBase.h"
#include "Engine/Loader/Loader.h"
#include "GW2/ArcDPS/ArcExtensionDef.h"

using ArcExtensionDef_t = ArcDPS::ExtensionDef_t;

constexpr const char* CH_ADDON = "Addon";

///----------------------------------------------------------------------------------------------------
/// CAddon Class
///----------------------------------------------------------------------------------------------------
class CAddon : public virtual IAddon
{
	public:
	///----------------------------------------------------------------------------------------------------
	/// ctor
	///----------------------------------------------------------------------------------------------------
	CAddon(std::filesystem::path aLocation);

	///----------------------------------------------------------------------------------------------------
	/// dtor
	///----------------------------------------------------------------------------------------------------
	~CAddon() override;

	///----------------------------------------------------------------------------------------------------
	/// GetSignature:
	/// 	Returns the unique signature of the addon.
	///----------------------------------------------------------------------------------------------------
	uint32_t GetSignature() override;

	///----------------------------------------------------------------------------------------------------
	/// GetName:
	/// 	Returns the name of the addon.
	///----------------------------------------------------------------------------------------------------
	std::string GetName();

	///----------------------------------------------------------------------------------------------------
	/// GetAuthor:
	/// 	Returns the author of the addon.
	///----------------------------------------------------------------------------------------------------
	std::string GetAuthor();

	///----------------------------------------------------------------------------------------------------
	/// GetDescription:
	/// 	Returns the description of the addon.
	///----------------------------------------------------------------------------------------------------
	std::string GetDescription();

	///----------------------------------------------------------------------------------------------------
	/// GetVersion:
	/// 	Returns the version of the addon.
	///----------------------------------------------------------------------------------------------------
	std::string GetVersion();

	///----------------------------------------------------------------------------------------------------
	/// GetConfig:
	/// 	Returns the config of the addon.
	///----------------------------------------------------------------------------------------------------
	Config_t* GetConfig();

	///----------------------------------------------------------------------------------------------------
	/// Load:
	/// 	Loads the addon.
	///----------------------------------------------------------------------------------------------------
	void Load() override;

	///----------------------------------------------------------------------------------------------------
	/// Unload:
	/// 	Unloads the addon.
	///----------------------------------------------------------------------------------------------------
	void Unload() override;

	///----------------------------------------------------------------------------------------------------
	/// Uninstall:
	/// 	Uninstalls the addon.
	///----------------------------------------------------------------------------------------------------
	void Uninstall();

	///----------------------------------------------------------------------------------------------------
	/// CheckUpdate:
	/// 	Checks if an update is available.
	///----------------------------------------------------------------------------------------------------
	void CheckUpdate(bool aIsScheduled = false);

	///----------------------------------------------------------------------------------------------------
	/// Update:
	/// 	Updates the addon.
	///----------------------------------------------------------------------------------------------------
	void Update();

	///----------------------------------------------------------------------------------------------------
	/// HasInterface:
	/// 	Returns true if the current module supports the passed interface.
	///----------------------------------------------------------------------------------------------------
	bool HasInterface(EAddonInterfaces aInterface) const;

	///----------------------------------------------------------------------------------------------------
	/// IsDuplicate:
	/// 	Checks if this addon is a duplicate.
	///----------------------------------------------------------------------------------------------------
	bool IsDuplicate();

	///----------------------------------------------------------------------------------------------------
	/// IsRunningAction:
	/// 	Returns true, if the addon is currently performing an action.
	///----------------------------------------------------------------------------------------------------
	bool IsRunningAction() const;

	///----------------------------------------------------------------------------------------------------
	/// IsDestroying:
	/// 	Returns true, if the addon is currently being destroyed.
	///----------------------------------------------------------------------------------------------------
	bool IsDestroying() const;

	///----------------------------------------------------------------------------------------------------
	/// IsFileLocked:
	/// 	Returns true, if the file on disk is locked and cannot be removed.
	///----------------------------------------------------------------------------------------------------
	bool IsFileLocked() const;

	///----------------------------------------------------------------------------------------------------
	/// IsStateLocked:
	/// 	Returns true, if the addon can no longer be loaded or unloaded.
	///----------------------------------------------------------------------------------------------------
	bool IsStateLocked() const;

	///----------------------------------------------------------------------------------------------------
	/// IsMissingRequirements:
	/// 	Returns true, if the addon interface is missing requirements for loading.
	///----------------------------------------------------------------------------------------------------
	bool IsMissingRequirements() const;

	///----------------------------------------------------------------------------------------------------
	/// IsUninstalled:
	/// 	Returns true, if the addon was uninstalled.
	///----------------------------------------------------------------------------------------------------
	bool IsUninstalled() const;

	///----------------------------------------------------------------------------------------------------
	/// IsUpdateAvailable:
	/// 	Returns true, if an update is available.
	///----------------------------------------------------------------------------------------------------
	bool IsUpdateAvailable() const;

	///----------------------------------------------------------------------------------------------------
	/// IsVersionDisabled:
	/// 	Returns true, if the specific addon version was disabled.
	///----------------------------------------------------------------------------------------------------
	bool IsVersionDisabled() const;

	///----------------------------------------------------------------------------------------------------
	/// SupportsLoading:
	/// 	Returns true, if the addon is loadable.
	///----------------------------------------------------------------------------------------------------
	bool SupportsLoading() const;

	///----------------------------------------------------------------------------------------------------
	/// SupportsUpdates:
	/// 	Returns true, if the addon is updateable.
	///----------------------------------------------------------------------------------------------------
	bool SupportsUpdates() const;

	///----------------------------------------------------------------------------------------------------
	/// SupportsPreReleases:
	/// 	Returns the true if the set provider supports pre-releases.
	///----------------------------------------------------------------------------------------------------
	bool SupportsPreReleases() const;

	///----------------------------------------------------------------------------------------------------
	/// GetProjectPageURL:
	/// 	Returns the project page of the set url, if applicable.
	///----------------------------------------------------------------------------------------------------
	std::string GetProjectPageURL() const;

	private:
	CLogApi*                 Logger               = nullptr;
	CLoader*                 Loader               = nullptr;
	CEventApi*               EventApi             = nullptr;
	CConfigMgr*              ConfigMgr            = nullptr;

	EAddonInterfaces         ModuleInterfaces     = EAddonInterfaces::None;
	EAddonFlags              Flags                = EAddonFlags::None;

	Config_t*                Config               = nullptr;
	
	AddonDefV1_t*            NexusAddonDefV1      = {};
	ArcExtensionDef_t*       ArcExtensionDef      = {};
	/* AlAddonDef_t*            AlAddonDef           = {}; */

	std::queue<EAddonAction> QueuedActions;
	std::condition_variable  ConVar;
	bool                     IsRunning            = false;
	std::mutex               ProcessorMutex;
	std::thread              ProcessorThread;

	long long                LastCheckedTimestamp = 0;
	std::filesystem::path    UpdateLocal;
	std::string              UpdateRemote;

	///----------------------------------------------------------------------------------------------------
	/// ProcessActions:
	/// 	Performs queued actions.
	///----------------------------------------------------------------------------------------------------
	void ProcessActions();

	///----------------------------------------------------------------------------------------------------
	/// LoadInternal:
	/// 	Loads the addon.
	///----------------------------------------------------------------------------------------------------
	void LoadInternal();

	///----------------------------------------------------------------------------------------------------
	/// UnloadInternal:
	/// 	Unloads the addon.
	///----------------------------------------------------------------------------------------------------
	void UnloadInternal();

	///----------------------------------------------------------------------------------------------------
	/// UninstallInternal:
	/// 	Uninstalls the addon.
	///----------------------------------------------------------------------------------------------------
	void UninstallInternal();

	///----------------------------------------------------------------------------------------------------
	/// CheckUpdateInternal:
	/// 	Checks if an update is available.
	///----------------------------------------------------------------------------------------------------
	void CheckUpdateInternal(bool aIsScheduled = false);

	///----------------------------------------------------------------------------------------------------
	/// CheckUpdateViaGitHub:
	/// 	Updates via GitHub.
	///----------------------------------------------------------------------------------------------------
	void CheckUpdateViaGitHub();

	///----------------------------------------------------------------------------------------------------
	/// CheckUpdateViaDirect:
	/// 	Updates via direct download.
	///----------------------------------------------------------------------------------------------------
	void CheckUpdateViaDirect();

	///----------------------------------------------------------------------------------------------------
	/// UpdateInternal:
	/// 	Updates the addon via remote or local.
	///----------------------------------------------------------------------------------------------------
	void UpdateInternal();

	///----------------------------------------------------------------------------------------------------
	/// ApplyLocalUpdate:
	/// 	Applies the update from local file.
	///----------------------------------------------------------------------------------------------------
	void ApplyLocalUpdate();

	///----------------------------------------------------------------------------------------------------
	/// DownloadUpdate:
	/// 	Downloads the update, returns true if successful.
	///----------------------------------------------------------------------------------------------------
	void DownloadUpdate();

	///----------------------------------------------------------------------------------------------------
	/// EnumInterfaces:
	/// 	Enumerates the addon interfaces associated with the file.
	///----------------------------------------------------------------------------------------------------
	const EAddonInterfaces& EnumInterfaces();

	///----------------------------------------------------------------------------------------------------
	/// ShouldLoad:
	/// 	Determines whether Load should be called.
	///----------------------------------------------------------------------------------------------------
	bool ShouldLoad();

	///----------------------------------------------------------------------------------------------------
	/// ShouldUpdate:
	/// 	Determines whether Update should be called.
	///----------------------------------------------------------------------------------------------------
	bool ShouldUpdate();

	///----------------------------------------------------------------------------------------------------
	/// IsVolatileDisabled:
	/// 	Returns true, if the addon is volatile and game build changed.
	///----------------------------------------------------------------------------------------------------
	bool IsVolatileDisabled();
};

static inline IAddon* IAddonFactory(std::filesystem::path aLocation)
{
	return new CAddon(aLocation);
}

#endif
